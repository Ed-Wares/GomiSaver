# This is a GitHub Action workflow to build a Windows C++ project
# using a Makefile (with make) and upload the binaries to a release.

name: Release

# ---
# TRIGGER
# ---
# This workflow runs when a new release is 'published' or 'prereleased'.
# It will NOT run when a release is just 'saved as a draft'.
# The intended workflow is:
# 1. You create a new release and save it as a draft.
# 2. When you are ready, you "Publish" it (either as a full or pre-release).
# 3. This action will then trigger, build, and upload the assets.
on:
  release:
    types: [published, prereleased]
 
# ---
# ENVIRONMENT VARIABLES
# ---
# Customize these variables for your project
env:
  # The name of your project. Used for naming the final .zip file.
  PROJECT_NAME: GomiSaver
  
  # The name of your Makefile.
  MAKEFILE_NAME: Makefile
  
  # The directory where your binaries (e.g., .exe, .dll) are built.
  # Assumes 'Release' folder in the root. Update if yours is different (e.g., 'build/Release').
  BUILD_OUTPUT_DIR: Release

jobs:
  build-and-upload:
    # Use the latest stable Windows runner
    runs-on: windows-latest
    permissions:
      contents: write # Grants write access to repository contents, including releases
      
    steps:
      # ---
      # STEP 1: Check out your repository's code
      # ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---
      # STEP 3: Build the C++ project using make
      # ---
      - name: make
        run: make

      # ---
      # STEP 4: Package the built binaries into a ZIP file
      # ---
      # This step finds all files in your BUILD_OUTPUT_DIR and zips them.
      - name: Package binaries into a ZIP file
        run: |
          $asset_name = "${{ env.PROJECT_NAME }}-${{ github.event.release.tag_name }}-winx64.zip"
          powershell Compress-Archive -Path ${{ env.BUILD_OUTPUT_DIR }}\* -DestinationPath $asset_name -Force
          echo "ASSET_PATH=$asset_name" >> $env:GITHUB_ENV
        shell: pwsh

      # ---
      # STEP 5: Upload the ZIP file to the GitHub Release
      # ---
      # This uses the 'gh' CLI (pre-installed) to upload the asset
      # to the release that triggered this workflow.
      - name: Upload binaries to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} ${{ env.ASSET_PATH }} --clobber
